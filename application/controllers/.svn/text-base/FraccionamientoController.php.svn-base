<?php

/**
 * Fraccionamiento
 * 
 * @author
 * @version 
 */

require_once 'Zend/Controller/Action.php';

class FraccionamientoController extends Zend_Controller_Action {
	/**
	 * The default action - show the home page
	 */
	
    public function init() {
    	//$this->view->util()->registerScriptJSController($this->getRequest());
    	 
    }
    
public function indexAction() {
	//$this->view->util()->registerScriptJSController($this->getRequest());
	
	echo "<script>pathReport='" . $this->view->util()->getPathReport() . "'</script>";
	
		$surl = new Zend_Session_Namespace ( 'url' );
		$url = $this->view->util()->getPath();
		
		$ddatosuserlog = new Zend_Session_Namespace('datosuserlog');
		$codcajero = $ddatosuserlog->codcajero;	
		
		$titordenanza = null;
		$do = '';
		$cont = null;
		
		$func = new Libreria_Pintar();
		//if ($codcajero > 0 || $ddatosuserlog->cidapertura !='') {
			$dcadgrabacion = new Zend_Session_Namespace('cadgrabacion' );
			$dcadgrabacion->data = '';
			
			$dorden = $this->_request->getParam ( 'ord', '' );
			$dorden='';
			//echo '<script>alert("'.$dorden.'")</script>';
			//$dordenanza = new Zend_Session_Namespace('ordenanza');
			
			$datospers = $this->_request->getParam ( 'datospers', '' );
			if ($datospers == '') {
				//$dordenanza->data = '';
				header ( 'location:' . $url . 'index.php/busqpers/?tipbus=cod&tit=Fraccionamiento&url=' . $url . 'index.php/fraccionamiento/?datospers=', true );
			} else {
				
				$ddetallepago = new Zend_Session_Namespace ( 'detallepago' );
				$ddetallepago->data = '';
				
				#cadena de conceptos de pagos arbitrios predios
				$data = new Zend_Session_Namespace ( 'arrayconceptos' );
				$data->data = '';
				
				//$ordenanza = $dordenanza->data;
				
				list ( $cidpers, $nompers, $dir , $fechaproyeccion ) = explode ( '|', $datospers );
				
				
				
				if ($cidpers == '_________1') {
					echo '<br><br><b><label style="font-size:12px;">Solo se aceptan contribuyentes registrados en el sistema.</label></b>';
					
					
					$val[0] = array("ContentTrib", '', "hide");
					$func->PintarValor($val);
				} else {
					$dcidpers = new Zend_Session_Namespace ( 'cidpers' );
					$dcidpers->data = $cidpers;
					
					$dnompers = new Zend_Session_Namespace ( 'nompers' );
					$dnompers->data = $nompers;
					
					if($fechaproyeccion == '' ){
						$nombrestore = '"public"."pxcobrowww"';
						$arraydatos [0] = '1';
						$arraydatos [1] = '';
						$arraydatos [2] = '';
						$cn = new Model_DataAdapter ();
						$datosfecha = $cn->ejec_store_procedura_sql ( $nombrestore, $arraydatos );
						$dfecha = explode ( " ", $datosfecha [0] [0] );
						$fechaproyeccion = $dfecha[0]; 
					}					
					
//					$nombrestore = 'dbo.pxCobroWWW';
//					$arraydatos [0] = array ('@idquery', '2' );
//					$arraydatos [1] = array ('@paramt0', $cidpers );
//					$cn = new Model_DataAdapter ();
//					$datoscontribuyentes = $cn->ejec_store_procedura_sql ( $nombrestore, $arraydatos );


					$nombrestore = 'tesoreria.fx_Estadocuenta';
					$arraydatos [0] = $cidpers ;
					$arraydatos [1] = '%' ;
					$arraydatos [2] = '0' ;
					$arraydatos [3] = $fechaproyeccion ;
					$arraydatos [4] = '0';
					$arraydatos [5] = '0';
					$arraydatos [6] = '%';
					
					$cn = new Model_DataAdapter ();
					$datos = $cn->ejec_store_procedura_sql ( $nombrestore, $arraydatos );
					
					$arrayprediosprinc = '';
					$arrayprediohijo = '';
					
					$arrayarbitriosprinc = '';
					$arrayarbitrioshijo = '';
					//$arrayarbitrioshijoaï¿½os = '';
					$arrayarbitrioshijosub = '';
					
					$arrayfraccprinc = '';
					$arrayfracchijo = '';

					$arraypagvariosprinc = '';
					$arraypagvarioshijo = '';

					$btnordparams = false;
					
					if (count ( $datos ) > 0) {
						
						for($i = 0; $i < count ( $datos ); $i ++) {
							
							$text = $datos [$i] [3];
							$id = $datos [$i] [0];
							$depth = $datos [$i] [23] + 1; // si es 2 es el padre y si es 3 es el hijo (ya se le ta sumando 1)
							$leaf = '';
							$checked = false;
							$children = '';
							/*print_r($datos [$i]);
							echo '<br>';echo '<br>';echo '<br>';*/
							$ctiping = $datos [$i] [1];
							$ctiprecval = $datos [$i] [2];
							$codpredio = ($datos [$i] [4] == '' ? 'No Especificado' : $datos [$i] [4]);
							$anio = $datos [$i] [5];
							$perid = trim ( $datos [$i] [6] );
							
							$nroval = $datos[$i][43].$datos[$i][44];
							
							$estad = $datos [$i] [7];
							
							$descripctiping = (($datos[$i][24] == '')?'No Especificado':$datos[$i][24]);# $datos[$i][24] es nulo U.u
							
							if ($dorden == '' || $dorden == null) {
								$idhijos = 'R' . '|'; //identificador q es un registro de cobro
								$idhijos .= $datos [$i] [0] . '|'; //idsigma de estcta 
								$idhijos .= $datos [$i] [2] . '|'; //ctiprec
								$idhijos .= $datos [$i] [3] . '|'; //tributo
								$idhijos .= (trim ( $datos [$i] [5] ) == '' ? '0000' : $datos [$i] [5]) . '|'; //aï¿½o
								$idhijos .= $datos [$i] [6] . '|'; //periodo
								$idhijos .= '-' . '|'; //dir
								//$idhijos .= $datos [$i] [21] . ' ' . $datos [$i] [22] . ' ' . $datos [$i] [20] . '|'; //direccion predio
								$idhijos .= $datos [$i] [8] . '|'; //imp. insoluto
								$idhijos .= $datos [$i] [9] . '|'; //factor de reajuste
								$idhijos .= $datos [$i] [10] . '|'; //imp. reajuste
								$idhijos .= $datos [$i] [11] . '|'; //fact. mora
								$idhijos .= $datos [$i] [12] . '|'; //imp. mora 
								$idhijos .= $datos [$i] [13] . '|'; //costo de emision
								$idhijos .= $datos [$i] [17] . '|'; // total
								$idhijos .= $datos [$i] [7] . '|'; // estado
								$idhijos .= (trim ( $datos [$i] [4] ) == '' ? '0000000000' : $datos [$i] [4]) . '|'; // codpredio
								$idhijos .= $datos [$i] [1]; // ctiping	
								$btnordparams = true;
							}
							if ($dorden == 'OK') { #ordenanza
								$idhijos = 'R' . '|'; //identificador q es un registro de cobro
								$idhijos .= $datos [$i] [0] . '|'; //idsigma de estcta 
								$idhijos .= $datos [$i] [2] . '|'; //ctiprec
								$idhijos .= $datos [$i] [3] . '|'; //tributo
								$idhijos .= (trim ( $datos [$i] [5] ) == '' ? '0000' : $datos [$i] [5]) . '|'; //aï¿½o
								$idhijos .= $datos [$i] [6] . '|'; //periodo
								$idhijos .= '-' . '|'; //dir
								//$idhijos .= $datos [$i] [21] . ' ' . $datos [$i] [22] . ' ' . $datos [$i] [20] . '|'; //direccion predio
								$idhijos .= $datos [$i] [8] . '|'; //imp. insoluto
								$idhijos .= $datos [$i] [9] . '|'; //factor de reajuste
								$idhijos .= $datos [$i] [14] . '|'; //imp. reajuste
								$idhijos .= $datos [$i] [11] . '|'; //fact. mora
								$idhijos .= $datos [$i] [15] . '|'; //imp. mora 
								$idhijos .= $datos [$i] [16] . '|'; //costo de emision
								$idhijos .= $datos [$i] [18] . '|'; // total
								$idhijos .= $datos [$i] [7] . '|'; // estado
								$idhijos .= (trim ( $datos [$i] [4] ) == '' ? '0000000000' : $datos [$i] [4]) . '|'; // codpredio
								$idhijos .= $datos [$i] [1]; // ctiping
								$btnordparams = false;
							}
							
							//predios padres
							if ($ctiprecval == '0000000273' && $depth == '2') {
								if ($arrayprediosprinc == '') {
									$arrayprediosprinc [0] = array ('text' => $text, 'id' => $id, 'depth' => $depth, 'leaf' => false, 'checked' => false, 'children' => '', 'enlace' => $ctiping . $anio . $codpredio, 'canthijos' => 0 );
								} else {
										//$cc = 99999;
										//for($z = 0 ; $z<count($arrayprediosprinc) ; $z++){
										//	if($arrayprediosprinc[$z]['enlace'] != $ctiping . $anio . $codpredio){
											 $conta = count ( $arrayprediosprinc );
											 $arrayprediosprinc [$conta] = array ('text' => $text, 'id' => $id, 'depth' => $depth, 'leaf' => false, 'checked' => false, 'children' => '', 'enlace' => $ctiping . $anio . $codpredio, 'canthijos' => 0 );	
										//	}
										//}
									
								}
							}
							//predios hijos
							if ($ctiprecval == '0000000273' && $depth == '3') { 
								for($j = 0; $j < count ( $arrayprediosprinc ); $j ++) {
									if ($arrayprediosprinc [$j] ['enlace'] == $ctiping . $anio . $codpredio ) {
										$arrayprediohijo [$arrayprediosprinc [$j] ['id']] [$arrayprediosprinc [$j] ['canthijos']] = array ('text' => $text . ' ' . $anio . ' ' . $perid, 'id' => $idhijos, 'depth' => $depth, 'leaf' => true, 'checked' => false  , 'children' => '', 'enlace' => $ctiping . $anio . $perid, 'canthijos' => 0 );
										$arrayprediosprinc [$j] ['children'] = $arrayprediohijo [$arrayprediosprinc [$j] ['id']];
										$arrayprediosprinc [$j] ['canthijos'] = $arrayprediosprinc [$j] ['canthijos'] + 1;
									}
								}
							}
							
							//arbitrios x predios
							if ($ctiprecval == '0000000278' && $depth == '2' && $perid == '') {
								if ($arrayarbitriosprinc == '') {
									$arrayarbitriosprinc [0] = array ('text' => $codpredio, 'id' => $id . $ctiping . $codpredio, 'depth' => $depth, 'leaf' => false, 'checked' => false, 'children' => '', 'enlace' => $ctiping . $codpredio, 'canthijos' => 0 );
									;
								} else {
									$ccont = count ( $arrayarbitriosprinc );
									$b = false;
									for($j = 0; $j < $ccont; $j ++) {
										if ($arrayarbitriosprinc [$j] ['enlace'] == $ctiping . $codpredio) {
											$b = true;
										}
									}
									if ($b == false) {
										$arrayarbitriosprinc [$ccont] = array ('text' => $codpredio, 'id' => $id . $ctiping . $codpredio, 'depth' => $depth, 'leaf' => false, 'checked' => false, 'children' => '', 'enlace' => $ctiping . $codpredio, 'canthijos' => 0 );
									}
								}
							}
							
							//arbitrios x anios por predios
							if ($ctiprecval == '0000000278' && $depth == '2' && $perid == '') {
								for($j = 0; $j < count ( $arrayarbitriosprinc ); $j ++) {
									if ($arrayarbitriosprinc [$j] ['enlace'] == $ctiping . $codpredio) {
										$arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$arrayarbitriosprinc [$j] ['canthijos']] = array ('text' => $text, 'id' => $id . $ctiping . $codpredio . $anio, 'depth' => $depth + 1, 'leaf' => false, 'checked' => false, 'children' => '', 'enlace' => $ctiping . $codpredio . $anio, 'canthijos' => 0 );
										$arrayarbitriosprinc [$j] ['children'] = $arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']];
										$arrayarbitriosprinc [$j] ['canthijos'] = $arrayarbitriosprinc [$j] ['canthijos'] + 1;
									}
								}
							}
							
							//arbitrios hijos
							if ($ctiping == '0000000278' && $depth == '3') {
								for($j = 0; $j < count ( $arrayarbitriosprinc ); $j ++) {
									for($k = 0; $k < count ( $arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] ); $k ++) {
										if ($arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$k] ['enlace'] === $ctiping . $codpredio . $anio) {
											$arrayarbitrioshijosub [$arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$k] ['id']] [$arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$k] ['canthijos']] = array ('text' => $text . ' ' . $anio . ' ' . $perid, 'id' => $idhijos, 'depth' => $depth + 1, 'leaf' => true, 'checked' => false, 'children' => '', 'enlace' => $codpredio . $anio . $perid, 'canthijos' => 0 );
											$arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$k] ['children'] = $arrayarbitrioshijosub [$arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$k] ['id']];
											$arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$k] ['canthijos'] = $arrayarbitrioshijo [$arrayarbitriosprinc [$j] ['id']] [$k] ['canthijos'] + 1;
										}
									}
									for($k = 0; $k < count ( $arrayarbitriosprinc [$j] ['children'] ); $k ++) {
										if ($arrayarbitriosprinc [$j] ['children'] [$k] ['enlace'] === $ctiping . $codpredio . $anio) {
											$arrayarbitrioshijosub [$arrayarbitriosprinc [$j] ['children'] [$k] ['id']] [$arrayarbitriosprinc [$j] ['children'] [$k] ['canthijos']] = array ('text' => $text . ' ' . $anio . ' ' . $perid, 'id' => $idhijos, 'depth' => $depth + 1, 'leaf' => true, 'checked' => false, 'children' => '', 'enlace' => $codpredio . $anio . $perid, 'canthijos' => 0 );
											$arrayarbitriosprinc [$j] ['children'] [$k] ['children'] = $arrayarbitrioshijosub [$arrayarbitriosprinc [$j] ['children'] [$k] ['id']];
											$arrayarbitriosprinc [$j] ['children'] [$k] ['canthijos'] = $arrayarbitriosprinc [$j] ['children'] [$k] ['canthijos'] + 1;
										}
									}
								}
							
							}
							
							/*
							//fracc padres
							if ($ctiprecval == '0000000312' && $depth == '2') {
								if ($arrayfraccprinc == '') {
									$arrayfraccprinc [0] = array ('text' => $text, 'id' => $id, 'depth' => $depth, 'leaf' => false, 'checked' => false, 'children' => '', 'enlace' => $ctiprecval . $text . $anio, 'canthijos' => 0 );
								} else {
									$conta = count ( $arrayfraccprinc );
									$arrayfraccprinc [$conta] = array ('text' => $text, 'id' => $id, 'depth' => $depth, 'leaf' => false, 'checked' => false, 'children' => '', 'enlace' => $ctiprecval . $text . $anio, 'canthijos' => 0 );
								}
							}
							//fracc hijos
							if ($ctiprecval == '0000000312' && $depth == '3') {
								for($j = 0; $j < count ( $arrayfraccprinc ); $j ++) {
									if ($arrayfraccprinc [$j] ['enlace'] === $ctiprecval . $text . $anio) {
//											if ($estad  == 'P')
//												$arrayfracchijo [$arrayfraccprinc [$j] ['id']] [$arrayfraccprinc [$j] ['canthijos']] = array ('text' => $text, 'id' => 'P|'.$idhijos, 'depth' => $depth, 'leaf' => true, 'checked' => false,'disabled' => true,'editable' => false,'icon'=>$url.'tree/images/drop-no.gif' , 'children' => '', 'enlace' => $ctiping . $anio . $perid, 'canthijos' => 0 );
//											else
												$arrayfracchijo [$arrayfraccprinc [$j] ['id']] [$arrayfraccprinc [$j] ['canthijos']] = array ('text' => $text, 'id' => $idhijos, 'depth' => $depth, 'leaf' => true, 'checked' => false , 'children' => '', 'enlace' => $ctiping . $anio . $perid, 'canthijos' => 0 );
												
										$arrayfraccprinc [$j] ['children'] = $arrayfracchijo [$arrayfraccprinc [$j] ['id']];
										$arrayfraccprinc [$j] ['canthijos'] = $arrayfraccprinc [$j] ['canthijos'] + 1;
									}
								}
							}*/
							
							//pagos varios 
									if($ctiping != '0000000273' && $ctiping != '0000000278' && $ctiping != '00000000312' && ($depth == '2' || $depth == '4' )){			
										if($arraypagvariosprinc == ''){
											$arraypagvariosprinc[0] = array('text'=>$descripctiping.' '.$anio,'id'=>$idhijos,'depth'=>$depth,'leaf'=>true,'checked'=>false,'children'=>'','enlace'=>$ctiping.$anio.$perid,'canthijos'=>0);
										}else{
											$conta = count($arraypagvariosprinc);
											$arraypagvariosprinc[$conta] = array('text'=>$descripctiping.' '.$anio,'id'=>$idhijos,'depth'=>$depth,'leaf'=>true,'checked'=>false,'children'=>'','enlace'=>$ctiping.$anio.$perid,'canthijos'=>0);
										}
									}
						
						}
						
						if ($arrayprediosprinc != null) {
							$arraysubroot [0] = array ('text' => 'Predial', 'id' => '0000000273', 'depth' => '1', 'leaf' => false, 'checked' => false, 'children' => '' );
							$arraysubroot [0] ['children'] = $arrayprediosprinc;
						}
						if ($arrayarbitriosprinc != null) {
							$arraysubroot [1] = array ('text' => 'Arbitrios', 'id' => '0000000278', 'depth' => '1', 'leaf' => false, 'checked' => false, 'children' => '' );
							$arraysubroot [1] ['children'] = $arrayarbitriosprinc;
						}
						if ($arrayfraccprinc != '') {
							$arraysubroot [2] = array ('text' => 'Fraccionamiento', 'id' => '0000000312', 'depth' => '1', 'leaf' => false, 'checked' => false, 'children' => '' );
							$arraysubroot [2] ['children'] = $arrayfraccprinc;
						}
						if ($arraypagvariosprinc != '') {
							$arraysubroot [3] = array ('text' => 'Pagos Varios', 'id' => '0000000979', 'depth' => '1', 'leaf' => false, 'checked' => false, 'children' => '' );
							$arraysubroot [3] ['children'] = $arraypagvariosprinc;
						}
						
						$arraysubroot = array_values ( $arraysubroot );
						
						$arrayroot [0] = array ('text' => 'Deuda Pendiente', 'id' => '0000000000', 'depth' => '0', 'leaf' => false, 'checked' => false, 'children' => '' );
						$arrayroot [0] ['children'] = $arraysubroot;
						
						if (strlen ( $dorden ) == 0) {
							$do = 'OK';
							$cadordenanza = 'Aplicar Ordenanza';
							$titordenanza = 'Sin Ordenanza';
						} else {
							$do = '';
							$cadordenanza = 'Quitar Ordenanza';
							$titordenanza = 'Ordenanza Activa';
						}
					
					} // Fin si hay o no deuda 
					
					if (count ( $datos ) > 0 ){	
			
						$cont ='<script type="text/javascript"><!--
										Ext.BLANK_IMAGE_URL = "' . $url . 'css/images/s.gif";
										Ext.EventManager.onDocumentReady(function() {
											tree = new Ext.tree.TreePanel(\'tree-div\',{
												animate:true,
												loader: new Ext.tree.CustomUITreeLoader({baseAttr:{uiProvider: Ext.tree.CheckboxNodeUI}}),
												enableDD:false,
												collapsible : true,
										        animCollapse: true,
												containerScroll: true,
												rootUIProvider: Ext.tree.CheckboxNodeUI,
												selModel:new Ext.tree.CheckNodeMultiSelectionModel(),
												rootVisible:false
											});
											
											tree.on(\'check\', function() {
												//Ext.get(\'cn\').dom.value = this.getChecked().join(\',\');
												//aki va el ajax para llenar los registros!!
												var registros = this.getChecked().join(\'^\');
												pintarregistrospagosarbitriospredios(registros,\'2\',\'http://' . $_SERVER ["HTTP_HOST"] . $_SERVER ['REQUEST_URI'] . '\');
											}, tree);
										
											// set the root node
											root = new Ext.tree.AsyncTreeNode({
														text: \'root\',
														draggable:false,
														id:\'source\',
														uiProvider: Ext.tree.CheckboxNodeUI,
														children: ' . json_encode ( $arrayroot ) . '
												    });
											
											tree.setRootNode(root);
										
											// render the tree
											tree.render();
											root.expand(false, false, function() {
												root.firstChild.expand(false);
												//Ext.get(\'cn\').dom.value = tree.getChecked().join(\',\');
												//ser();
											});
											
											//Ext.get(\'exp\').on(\'click\', function() { tree.expandAll();});
											
											//Ext.get(\'coll\').on(\'click\', function() {tree.collapseAll();});
											
											//Ext.get(\'ser\').on(\'click\', ser);
										});
										
										//ser = function() {
										//	var c = Ext.get(\'c\');
										//	c.dom.style.display=\'block\';
										//	c.dom.firstChild.innerHTML = tree.getChecked();
										//};
										
										//--></script>
										
										<style>
										
										<style>
										//	#c {display:none;} 
										</style>
										
										<!--
										<input type="button" id="ser" value="Serialize Checked Nodes" />
										<br />
										<div id="c"><pre class="code"></pre></div>
										<b>Checked Nodes: </b> <input type="text" id="cn" value="" size="40" autocomplete="off" /><br />
										<br />
										-->';

					}

					if (count($datos) > 0){
						//$forma = '<input type="button" id="btnordenanza" name="btnordenanza" value="' . $cadordenanza . '" onclick="" />';
						$forma ='';
						$tree = '<div id="tree-div" style="overflow:scroll; height:100%;width:230px;border:1px solid #c3daf9;"></div>';
						
					}else{
						$forma = '';
						$tree = '<div style="overflow:scroll; height:100%;width:100%;border:1px solid #c3daf9;"><table height="100%" width="100%"><tr valign="middle"><td align="center"><b>No tiene Deuda Pendiente</b></td></tr></table></div>';
					}
					$botones = '';
					if ($codcajero == '0099'){
						// $botones  = '<input type="button"  id="btnfraccionamiento" name="btnfraccionamiento" value="Fraccionamiento" onclick="ventanafraccionamiento(\\\'http://' . $_SERVER ["HTTP_HOST"] . $_SERVER ['REQUEST_URI'] . '\\\')" />';
						// $botones .= '<input type="button" id="btndescargo" name="btndescargo" value="Descargo de Recibo" onclick="descargoregistrospagosarbitriospredios()" />';
						
						//$botones .= '<input type="button" id="btncobrar" name="btncobrar" value="Cobrar" onclick="cobrarregistrospagosarbitriospredios()" />';
						#modificado para que entre defrente  la pantalla de detalle de pago
						$botones .= '<input type="button" id="btnprocesar" name="btnprocesar" value="Procesar" />';
					} else if ($codcajero == '0050'){
						$botones = '<input type="button" id="btndescargo" name="btndescargo" value="Descargo de Recibo" onclick="descargoregistrospagosarbitriospredios()" />';
					} else {
						//$botones = '<input type="button" id="btncobrar" name="btncobrar" value="Cobrar" onclick="cobrarregistrospagosarbitriospredios()" />';
						#modificado para que entre defrente  la pantalla de detalle de pago
						$botones .= '<input type="button" id="btnprocesar" name="btnprocesar" value="Procesar" />';
					}
						
					$val[0] = array("cidpers", $cidpers, "html");
					$val[1] = array("nompers", $nompers, "html");
					$val[2] = array("dirpers", $dir, "html");
					$val[3] = array("btnord", $forma, "html");
					if($titordenanza != null) {
						$val[4] = array("isordenanza", '<font size="+1"><b>' . $titordenanza . '<b></font>', "html");
					}
					$val[5] = array("div_rptapagoarbitriospredios", $botones, "html");
					$val[6] = array("txt_fechaproyeccion", $fechaproyeccion, "val");
					$val[7] = array("btord", $tree, "html");
					
					//$val[6] = array("arbol", $scarb, "html");

					//$val[0] = array("arbol", $scarb, "html");
					
					//$evt[0] = array("btnrecibos", "click", "ventanarecibosxconribuyente('" . $cidpers . "');");
					$evt[1] = array("btnestcta", "click", "ventanaestctacajero('" . $cidpers . "');");
					$evt[2] = array("btnordenanza", "click", "window.open('" . $url . "index.php/fraccionamiento/?datospers=" . $datospers . "&ord=" . $do . "','_self')");
					$evt[3] = array("btnconvenios", "click", 'ventanaconvenio(\'0\',\'http://' . $_SERVER ['HTTP_HOST'] . $_SERVER ['REQUEST_URI'] .'\');');
					$evt[4] = array('txt_fechaproyeccion', 'click', 'displayCalendar(this,"yyyy-mm-dd" ,this);');					
					$evt[5] = array('btn_recalculardeuda', 'click', "window.open('" . $url . "index.php/fraccionamiento/?datospers=" . $cidpers. "|". $nompers."|". $dir. "|". "'+$('#txt_fechaproyeccion').val()+'" . "&ord=" . $dorden . "','_self')"); //$cidpers, $nompers, $dir , $fechaproyeccion
					
					$evt[] = array("btnsalir", "click", "window.open('".$url."index.php/fraccionamiento?datospers=','_self');");
					$evt[] = array("nuevorecibo", "click", "location.reload();");
					$sl[0] = array('txt_fechaproyeccion',true);

					$hab[0] = array('btn_recalculardeuda',false);
					//$hab[1] = array('btnordenanza',false);
					
					$func->PintarValor($val);
					$func->PintarEvento($evt);
					$func->ComponenteSoloLectura($sl);
					$func->HabilitarComponente($hab);
					if($cont != null) {
						echo $cont;	
					}
				}
			} //fin del else para los datos enviados
		//} else {
			//$val[0] = array("arbol", "No tienes privilegios de cajero para este modulo", "html");
			$func->PintarValor($val);
			
			//echo 'No tienes privilegios de cajero para este modulo.';
		//} //fin condicion de cajero	
	}
	
	public function pintarregistrosAction() {
		$this->_helper->layout->disableLayout ();
		$this->_helper->getHelper ( 'ajaxContext' )->initContext ();
		
		if ($this->getRequest ()->isXmlHttpRequest ()) {
			//$this->_helper->viewRenderer->setNoRender ();
			$this->_helper->layout->disableLayout ();
			
			#$duserlogin = new Zend_Session_Namespace ( 'userlogin' );
			#$userlogin = $duserlogin->data;
			
			$ddatosuserlog = new Zend_Session_Namespace('datosuserlog');
			$userlogin = $ddatosuserlog->userlogin;
			
			
			$registros = $this->_request->getPost ( 'registros' );
			$url = $this->_request->getPost ( 'url' );
			$ord = $this->_request->getPost ( 'ord' );
			$reajustecentimos = $this->_request->getPost ( 'reajustecentimos' );
			
			
			//echo  $registros;
			
			//0//			$idhijos =  'R'.'|'; //identificador q es un registro de cobro
			//1//*						$idhijos .= $datos[$i][0].'|';  //idsigma de estcta 
			//2//*						$idhijos .=	$datos[$i][2].'|';  //ctiprec
			//3//						$idhijos .=	$datos[$i][3].'|';  //tributo
			//4//*						$idhijos .=	$datos[$i][5].'|';  //aï¿½o
			//5//						$idhijos .=	$datos[$i][6].'|';  //periodo
			//6//						$idhijos .=	$datos[$i][17].' '.$datos[$i][18].' '.$datos[$i][16].'|';  //direccion predio
			//7//*						$idhijos .=	$datos[$i][8].'|';  //imp. insoluto
			//8//*						$idhijos .=	$datos[$i][9].'|';  //factor de reajuste
			//9//*						$idhijos .=	$datos[$i][10].'|'; //imp. reajuste
			//10//*						$idhijos .=	$datos[$i][11].'|'; //fact. mora
			//11//*						$idhijos .=	$datos[$i][12].'|'; //imp. mora 
			//12//*						$idhijos .=	$datos[$i][13].'|'; //costo de emision
			//13//*						$idhijos .=	$datos[$i][14]; // total
			//fecha de pago
			//observaciones
			//14//*						$idhijos .=	$datos[$i][7]; // estado
			//15//*						$idhijos .=	$datos[$i][4]; // codpredio
			//numero de recibo manual
			//16//*						$idhijos .=	$datos[$i][1]; // ctiping
			

			$cadgrabacion = '';
			$cadkiebre = '';
			$buscarestado = array ('0', '3', 'B', 'D', 'F', 'P' );
			$ponercolor = array ('#ffffff', '#6bc5c5', '#ffc270', '#e67053', '#b0cff6', '#6bc5c5' );
			$sumtotal = 0.00;
			$func = new Libreria_Pintar();
			
			$detail = '<table border="0" cellspacing="0" cellpadding="0" style="font-size:12px">';
			
			if (strlen ( $registros ) > 0) {
				$datos = explode ( "^", $registros );
				for($i = 0; $i < count ( $datos ); $i ++) {
					$datoscol = explode ( "|", $datos [$i] );
					if (substr ( $datoscol [0], 0, 1 ) == 'R') {
						//para el total
						$sumtotal = $sumtotal + $datoscol [13];			
						//llenando el cadena de grabacion para la sesion								
						$cadgrab  = $datoscol [1] . '^'; //idsigma de estcta//0
						$cadgrab .= $datoscol [2] . '^'; //ctiprec//1
						$cadgrab .= number_format ( $datoscol [7], '2', '.', '' ) . '^'; //imp. insoluto//2
						$cadgrab .= number_format ( $datoscol [8], '2', '.', '' ) . '^'; //factor de reajuste//3
						$cadgrab .= number_format ( $datoscol [9], '2', '.', '' ) . '^'; //imp. reajuste//4
						$cadgrab .= number_format ( $datoscol [10], '2', '.', '' ) . '^'; //fact. mora//5
						$cadgrab .= number_format ( $datoscol [11], '2', '.', '' ) . '^'; //imp. mora//6
						$cadgrab .= number_format ( $datoscol [12], '2', '.', '' ) . '^'; //costo de emision//7
						$cadgrab .= number_format ( $datoscol [13], '2', '.', '' ) . '^'; // total//8
						$cadgrab .= 'fechpago' . '^'; //9
						$cadgrab .= '/' . '^'; //10
						$cadgrab .= 'estrec' . '^'; // estado//11
						$cadgrab .= $userlogin;

						// Llenando el cadena de kiebre	
						$cadkiebre .= $cadgrab . '@'; //idsigma de estcta//0
						$cadkiebre .= trim ( $datoscol [15] ) == '' ? '0000000000' : $datoscol [15] . '@'; // codpredio//1
						$cadkiebre .= $datoscol [16] . '@'; // ctiping//2
						$cadkiebre .= trim ( $datoscol [4] ) == '' ? '0000' : $datoscol [4] . '@'; // aï¿½o//3	
						$cadkiebre .= number_format ( $datoscol [13], '2', '.', '' ); // total//4		
						$cadkiebre .= '@'.$datoscol [3].'@'.$datoscol [5];						
						$cadkiebre .= '~';
						
						// Para pintar la tabla	
						$detail .= '<tr style="background-color:' . str_replace ( $buscarestado, $ponercolor, $datoscol [14] ) . '" >';
						$detail .= '<td width="50" align="center">' . $datoscol [3] . '</td>';
						$detail .= '<td width="48" align="center">' . $datoscol [4] . '</td>';
						$detail .= '<td width="49" align="center">' . $datoscol [5] . '</td>';
						$detail .= '<td width="63" align="center">' . number_format ( $datoscol [7], '2', '.', '' ) . '</td>';
						$detail .= '<td width="65" align="center">' . number_format ( $datoscol [9], '2', '.', '' ) . '</td>';
						$detail .= '<td width="55" align="center">' . number_format ( $datoscol [11], '2', '.', '' ) . '</td>';
						$detail .= '<td width="61" align="center">' . number_format ( $datoscol [12], '2', '.', '' ) . '</td>';
						$detail .= '<td width="61" align="center">' . number_format ( $datoscol [13], '2', '.', '' ) . '</td>';
						$detail .= '</tr>';
						//$detail .= '<tr><td colspan="9"><hr/></td></tr>';
					}
				}
				$cadkiebre = substr ( $cadkiebre, 0, strlen ( $cadkiebre ) - 1 );
			}
			
			/* Aumentar par el kite de los centimos*/
			
			$dcodcajero = new Zend_Session_Namespace ( 'codcajero' );
			$codcajero = $dcodcajero->data;			
			
			/* Para el redondedo por operacion*/
			$arraydatosope = null;
			$dat = null;
			if ( $reajustecentimos == '2'  ){
				$dat = null;
				if(strlen($cadkiebre) > 0)
					$dat = explode ( "~", $cadkiebre );
				
				for($i = 0; $i < count ( $dat ); $i ++) {
					$datos = explode ( "@", $dat [$i] );
					#echo "<script>console.log('".json_encode($datos)."');</script>";
					$cad = trim ( $datos [0] );
					$codpre = trim ( $datos [1] );
					$tributo = trim ( $datos [2] );
					$anio = trim ( $datos [3] );
					$total = trim ( $datos [4] );
					$trib = trim ( $datos [5] );
					$perid = trim ( $datos [6] );
					
					
					if ($arraydatosope == '' || $arraydatosope == null || count ( $arraydatosope ) == 0) {
						
						$arraydatosope [0] [0] = $cad; //cadena
						$arraydatosope [0] [1] = $codpre; //predio
						$arraydatosope [0] [2] = $tributo; //tributo
						$arraydatosope [0] [3] = $anio; //año
						$arraydatosope [0] [4] = $total; //total
						$arraydatosope [0] [5] = $trib; //trib
						$arraydatosope [0] [6] = $perid; //perid
					} else {
						$arraydatosope [0] [0] .= '~' . $cad;
						$arraydatosope [0] [1] = $codpre; //predio
						$arraydatosope [0] [2] = $tributo; //tributo
						$arraydatosope [0] [3] = $anio; //año
						$arraydatosope [0] [4] = $arraydatosope [0] [4] + $total; //total
						$arraydatosope [0] [5] = $trib; //trib
						$arraydatosope [0] [6] = $perid; //perid
					}
				}
				echo "<script>console.log('".json_encode($arraydatosope)."');</script>";
				#ECHO count ($dat);
				if(count($dat)!=0 || $dat!= null || $dat!="" ){
					$total = number_format( $arraydatosope[0][4], '1', '.', '' );
					$subttotaldiff = number_format( $total - $arraydatosope[0][4] , '2', '.', '' );
					
					if($subttotaldiff != 0.00 && $subttotaldiff != 0.05){
						$datoscad = explode ( "~", $arraydatosope[0][0] );
						$max = count($datoscad)-1;
						
						$datossubcad = explode ( "^", $datoscad[$max] );
						$sumtotal = $sumtotal + $subttotaldiff;
						//llenando el cadena de grabacion para la sesion
						$cadgrab  = $datossubcad [0] . '^'; //idsigma de estcta//0
						$cadgrab .= '0000007931' . '^'; //ctiprec//1
						$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //imp. insoluto//2
						$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //factor de reajuste//3
						$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //imp. reajuste//4
						$cadgrab .= number_format ( 1 , '2', '.', '' ) . '^'; //fact. mora//5
						$cadgrab .= number_format ( $subttotaldiff, '2', '.', '' ) . '^'; //imp. mora//6
						$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //costo de emision//7
						$cadgrab .= number_format ( $subttotaldiff, '2', '.', '' ) . '^'; // total//8
						$cadgrab .= 'fechpago' . '^'; //9
						$cadgrab .= '/' . '^'; //10
						$cadgrab .= 'R' . '^'; // estado//11
						$cadgrab .= $userlogin;
					
						// Llenando el cadena de kiebre
						$cadkiebre .= '~';
						$cadkiebre .= $cadgrab . '@'; //idsigma de estcta//0
						$cadkiebre .= $arraydatosope[0][1] . '@'; // codpredio//1
						$cadkiebre .= $arraydatosope[0][2] . '@'; // ctiping//2
						$cadkiebre .= $arraydatosope[0][3] . '@'; // aï¿½o//3
						$cadkiebre .= number_format ( $subttotaldiff , '2', '.', '' );
						$cadkiebre .= '@'.$arraydatosope[0][5].'@'.$arraydatosope[0][6];	// total//4
						
						// Para pintar la tabla
						$detail .= '<tr style="background-color:#FFCCFF" >';
						$detail .= '<td width="45" align="center">AJ</td>';
						$detail .= '<td width="49" align="center">' . $arraydatosope[0][3] . '</td>';
						$detail .= '<td width="49" align="center">' . $arraydatosope[0][6] . '</td>';
						$detail .= '<td width="61" align="center">' . number_format ( 0 , '2', '.', '' ) . '</td>';
						$detail .= '<td width="64" align="center">' . number_format ( 0 , '2', '.', '' ) . '</td>';
						$detail .= '<td width="60" align="center">' . number_format ( $subttotaldiff , '2', '.', '' ) . '</td>';
						$detail .= '<td width="61" align="center">' . number_format ( 0 , '2', '.', '' ) . '</td>';
						$detail .= '<td width="50" align="center">' . number_format ( $subttotaldiff , '2', '.', '' ) . '</td>';
						$detail .= '</tr>';
					
					}
				}
				
			}	
				
			/*Redondeo por recibo*/
			#if( $codcajero != '0050'  && $reajustecentimos == '1'  ){
			$dat = null;
			if( $reajustecentimos == '1'  ){
				$dat = null;
				if(strlen($cadkiebre) > 0)
					$dat = explode ( "~", $cadkiebre );
				
				//echo json_encode($dat);
				
//				echo "<script>console.log('".json_encode($dat)."');</script>";
				$arraydatos = null;	
				
				for($i = 0; $i < count ( $dat ); $i ++) {
					$datos = explode ( "@", $dat [$i] );
					#echo "<script>console.log('".json_encode($datos)."');</script>";
					$cad = trim ( $datos [0] );
					$codpre = trim ( $datos [1] );
					$tributo = trim ( $datos [2] );
					$anio = trim ( $datos [3] );
					$total = trim ( $datos [4] );
					$trib = trim ( $datos [5] );
					$perid = trim ( $datos [6] );
					
					if ($arraydatos == '' || $arraydatos == null || count ( $arraydatos ) == 0) {
						$arraydatos [0] [0] = $cad; //cadena
						$arraydatos [0] [1] = $codpre; //predio
						$arraydatos [0] [2] = $tributo; //tributo
						$arraydatos [0] [3] = $anio; //año
						$arraydatos [0] [4] = $total; //total
						$arraydatos [0] [5] = $trib; //trib
						$arraydatos [0] [6] = $perid; //perid
					} else {
						$b = null; //contador de posicion de $arraydatos
						for($k = 0; $k < count ( $arraydatos ); $k ++) {
							if ($arraydatos [$k] [1] == $codpre && $arraydatos [$k] [2] == $tributo && $arraydatos [$k] [3] == $anio) {
								$b = $k;
							} else {
								$b = 99999;
							}
						}
						if ($b == 99999) {
							$c = count ( $arraydatos );
							$arraydatos [$c] [0] = $cad; //cadena
							$arraydatos [$c] [1] = $codpre; //predio
							$arraydatos [$c] [2] = $tributo; //tributo
							$arraydatos [$c] [3] = $anio; //año
							$arraydatos [$c] [4] = $total; //total
							$arraydatos [$c] [5] = $trib; //total
							$arraydatos [$c] [6] = $perid; //PERIOD
						} else {
							$arraydatos [$b] [0] .= '~' . $cad;
							$arraydatos [$b] [4] = $arraydatos [$b] [4] + $total;
						}				
					}
					
					#echo "<script>console.log('".json_encode($arraydatos)."');</script>";
				}
				#echo "<script>console.log('".json_encode($arraydatos)."');</script>";
				
				
				for($i = 0 ; $i <count($arraydatos) ; $i++){
					
					#print_r($arraydatos);
					$total = number_format( $arraydatos[$i][4], '1', '.', '' );
					$subttotaldiff = number_format( $total - $arraydatos[$i][4] , '2', '.', '' );
					
					#echo "<script>console.log('".$total."');</script>";
					#echo "<script>console.log('".$subttotaldiff."');</script>";
					
					//echo "<script>alert('".$total." - ".$arraydatos[$i][4]." = ".$subttotaldiff."');</script>";
					if($subttotaldiff != 0.00 && $subttotaldiff != 0.05){
						$datoscad = explode ( "~", $arraydatos[$i][0] );
						$max = count($datoscad)-1;
							$datossubcad = explode ( "^", $datoscad[$max] );
							$sumtotal = $sumtotal + $subttotaldiff;			
							//llenando el cadena de grabacion para la sesion								
							$cadgrab  = $datossubcad [0] . '^'; //idsigma de estcta//0
							$cadgrab .= '0000007931' . '^'; //ctiprec//1
							$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //imp. insoluto//2
							$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //factor de reajuste//3
							$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //imp. reajuste//4
							$cadgrab .= number_format ( 1 , '2', '.', '' ) . '^'; //fact. mora//5
							$cadgrab .= number_format ( $subttotaldiff, '2', '.', '' ) . '^'; //imp. mora//6
							$cadgrab .= number_format ( 0 , '2', '.', '' ) . '^'; //costo de emision//7
							$cadgrab .= number_format ( $subttotaldiff, '2', '.', '' ) . '^'; // total//8
							$cadgrab .= 'fechpago' . '^'; //9
							$cadgrab .= '/' . '^'; //10
							$cadgrab .= 'R' . '^'; // estado//11
							$cadgrab .= $userlogin;
	
							// Llenando el cadena de kiebre	
							$cadkiebre .= '~';
							$cadkiebre .= $cadgrab . '@'; //idsigma de estcta//0
							$cadkiebre .= $arraydatos[$i][1] . '@'; // codpredio//1
							$cadkiebre .= $arraydatos[$i][2] . '@'; // ctiping//2
							$cadkiebre .= $arraydatos[$i][3] . '@'; // aï¿½o//3	
							$cadkiebre .= number_format ( $subttotaldiff , '2', '.', '' ); 
							$cadkiebre .= '@'.$arraydatos[$i][5].'@'.$arraydatos[$i][6];	// total//4	
							
							// Para pintar la tabla	
							$detail .= '<tr style="background-color:#FFCCFF" >';
							$detail .= '<td width="45" align="center">' . $arraydatos[$i][5] . '</td>';
							$detail .= '<td width="49" align="center">' . $arraydatos[$i][3] . '</td>';
							$detail .= '<td width="49" align="center">' . $arraydatos[$i][6] . '</td>';
							$detail .= '<td width="61" align="center">' . number_format ( 0 , '2', '.', '' ) . '</td>';
							$detail .= '<td width="64" align="center">' . number_format ( 0 , '2', '.', '' ) . '</td>';
							$detail .= '<td width="60" align="center">' . number_format ( $subttotaldiff , '2', '.', '' ) . '</td>';
							$detail .= '<td width="61" align="center">' . number_format ( 0 , '2', '.', '' ) . '</td>';
							$detail .= '<td width="50" align="center">' . number_format ( $subttotaldiff , '2', '.', '' ) . '</td>';
							$detail .= '</tr>';
							
					}
				}
			
			}

			/*fin de kite de centimos*/
			
			
			//echo $cadkiebre;
			
			//$detail .= '</table>';
			//metemos la cadena de grabacion en la session xD!
			$dcadgrabacion = new Zend_Session_Namespace ( 'cadgrabacion' );
			$dcadgrabacion->data = $cadkiebre . 'ï¿½' . $sumtotal . 'ï¿½' . $url . '&ord=' . $ord;
			//echo $detail;
			$total = number_format ( $sumtotal, '2', '.', '' ) ;
			$val[0] = array("detail",$detail,"html");
			$val[1] = array("stotal",$total,"html");
			$func->PintarValor($val);
			//echo $cont;
			

		}
	}
	
  public function proyectarfraccAction() {
        $this->_helper->getHelper('ajaxContext')->initContext();

        if ($this->getRequest()->isXmlHttpRequest()) {
            $this->_helper->layout->disableLayout();
                        
            $totalfracc = $this->_request->getPost('totalfracc'); 
            $nrocuotas = $this->_request->getPost('nrocuotas'); 
            $inicial  = $this->_request->getPost('inicial'); 
            
        }
        
       // $totalfracc = '1000';
        //$nrocuotas = '6';
        //$inicial = '0';  
        
        $montofracc=$totalfracc - $inicial;
        $cuotamonto;        
        $amortizacion=$montofracc;        
        $montodescuento=0;        
        $hoy = Date("d-m-Y");        
        $interes;        
        $Ui;        
        $xAux;        
        $R;        
        $xInteFra;        
        $totalfinal=0;        
        $interes = ((1.2 * 0.8)/100);        
        $Ui = 1 + $interes;
        
        for($i=1; $i<$nrocuotas; $i++){
        	$Ui = $Ui * (1 + $interes);
        }
         
        $xAux = ( $Ui - 1 ) / ($interes * $Ui);
         
        $R  = round($montofracc /$xAux,2);
        
        $newcontent =  '<table border="1" bordercolor="black" width="80%">';
        $newcontent .= '<tr>';
        //newcontent += '<th width="50px">Amortizacion</th>';
        $newcontent .= '<th align="center" width="50px"><b>Cuota</b></th>';
        $newcontent .= '<th align="center" width="80px"><b>Fecha de Vencimiento</b></th>';
        $newcontent .= '<th align="center" width="50px"><b>Int.Fracc</b></th>';
        $newcontent .= '<th align="center" width="50px"><b>Monto</b></th>';
        $newcontent .= '<th align="center" width="50px"><b>Total</b></th>';
        $newcontent .= '</tr>';
         
        
        for($i=0; $i<=$nrocuotas; ++$i){ 
         
        	$cd = strtotime(date('d-m-Y'));
        	$retDAY = date('d-m-Y', mktime(0,0,0,date('m',$cd)+$i,date('d',$cd),date('Y',$cd)));
        	//echo $retDAY ."</br>";
        	 
        	
        	if ($i==0){
        		$cadcontentrow = '<tr>';
        		//cadcontentrow += '<td align="center" width="50px">&nbsp;' +montofracc + '</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' .$i .'</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' . $retDAY .'</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' . 0 .'</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' .$inicial . '</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' .(($inicial)) . '</td>';
        		$cadcontentrow .= '</tr>';  
        	}
        	else{
        
        		$xInteFra   = $amortizacion * $interes;
        		$montodescuento = $R - $xInteFra;
        			
        		//montodescuento=montodescuento+cuotamonto;
        			
        		//amortizacion=parseFloat(montofracc)- parseFloat(montodescuento);
        			
        		$cadcontentrow = '<tr>';
        		//cadcontentrow += '<td align="center" width="50px">&nbsp;' +Math.round(amortizacion) + '</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' . $i  . '</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' .$retDAY  . '</td>'; 
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' . round(($xInteFra)*100)/100  . '</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;'  .round(($montodescuento)*100)/100 . '</td>';
        		$cadcontentrow .= '<td align="center" width="50px">&nbsp;' .((($R)*100)/100) . '</td>';
        		$cadcontentrow .= '</tr>';
        			
        		$amortizacion = $amortizacion - $montodescuento;
        
        		$totalfinal = $totalfinal + ((($R)*100)/100) ;
        	}
        
        	$newcontent .= $cadcontentrow;
        	//console.log(mes+i);
        	//hoy.setMonth(0);
        	//hoy.setMonth(mes+i+1);
        }
        
        $newcontent .= "</table>";
        
        //$("#locategridresultestctacte").html(newcontent);
        
        //$("#txtdeutotfracc").val(totalfinal+(parseFloat(inicial)));
                
        $pintar= new Libreria_Pintar();
        
        $val[]=array('locategridresultestctacte', $newcontent,'html');  
        $val[]=array('txtdeutotfracc',($totalfinal+$inicial),'val');
        $pintar->PintarValor($val);   
        
    }
    
    public function contratofraccAction(){
    		//$this->view->util()->registerScriptJSControllerAction($this->getRequest());
    	     $this->_helper->layout->disableLayout();
    	     
    	     
    	     $cidpers=$this->_request->getParam('cidpers');
    	     $nomperson=$this->_request->getParam('nomperson');
    	     $dirperson=$this->_request->getParam('dirperson'); 
    	     $monto=$this->_request->getParam('monto');
    	     $numcuotas=$this->_request->getParam('numcuotas');
    	     $cuotaini=$this->_request->getParam('cuotaini');
    	     
    	     
    	     $pintar= new Libreria_Pintar();
		     
    	    // $arrtipodoc = array(array('0000000001', 'DNI'), array('0000000002', 'RUC'));
    	    // $arrcodpostal = array(array('0000000001', 'Puente Piedra'), array('0000000002', 'otros'));
    	     
    	     $procedure = 'registro.mubigeodistr';
    	     $params[0] = '15';
    	     $params[1] = '01';
    	     $params[2] = '00';
    	     
    	     $dataSet = new Model_DataAdapter();
    	     
    	     $arrcodpostal = $dataSet->ejec_store_procedura_sql($procedure, $params);
    	     
     	     $val[] = array('cdistrito_titular', $pintar->ContenidoCombo($arrcodpostal, ''), 'html');
    	     
    	    // $val[] = array('ctipdoc_garante', $pintar->ContenidoCombo($arrtipodoc, ''), 'html');
    	     
    	     $val[] = array('cdistrito_garante', $pintar->ContenidoCombo($arrcodpostal, ''), 'html');
    	     
    	     $val[] = array('txtfechfracc',date('y-m-d'),'val');
    	     
    	     $val[] = array('txtnrocuotas2',$numcuotas,'val');    

    	      $val[] = array('txtcuotainicial2',$cuotaini,'val'); 
    	     
    	     $val[] = array('txttotalfracc', round($monto,2) , 'val');
    	     
    	     $evt[]=array('txtporcuoini','blur','inicial('.$monto.');');
		
			 //$evt[]=array('txtcuotainicial2','keyup','cuotas();');
			 
    	     $val[] = array('cnombres_titular',$nomperson,'val');
    	     $val[] = array('cdomicilio_titular',$dirperson,'val'); 
    	     
			 $fun[]= array('$("#txtcuotainicial2").on("keyup", function(e) {
			 	if(e.keyCode == 13 ){
			 		cuotas();
			 	}
			 });');
			  
    	     $pintar->PintarValor($val);
    	     $pintar->PintarEvento($evt);
    	     $pintar->EjecutarFuncion($fun); 
    	
    }
	
	public function fracproyAction(){
		//$this->view->util()->registerScriptJSControllerAction($this->getRequest());
		$pintar= new Libreria_Pintar();
		
		$evt[]=array('txtporcuotas','blur','inicial(1000);');
		
		$evt[]=array('txtcuotainicial','blur','cuotas();');
		
	    $pintar->PintarEvento($evt);
	}
	
	public function grabarfraccAction(){
		$this->_helper->layout->disableLayout();
		$this->_helper->viewRenderer->setNoRender();
		$this->_helper->getHelper('ajaxContext')->initContext();
			if ($this->getRequest()->isXmlHttpRequest()) {
			
			$p_idsigma=$this->_request->getPost('p_idsigma');
            $p_cnumfra=$this->_request->getPost('p_cnumfra');         
            $p_canofra=date('Y');           
	        $p_cidpers=$this->_request->getPost('p_cidpers');
	        $p_ctipdoc_titular=$this->_request->getPost('p_ctipdoc_titular');
	        $p_descdoc_titular=$this->_request->getPost('p_descdoc_titular');
	        $p_cnombres_titular=$this->_request->getPost('p_cnombres_titular');
	        $p_cdomicilio_titular=$this->_request->getPost('p_cdomicilio_titular');
	        $p_cdistrito_titular=$this->_request->getPost('p_cdistrito_titular');
            $p_ctelef_fijo_titular=$this->_request->getPost('p_ctelef_fijo_titular');
            $p_ctelef_movil_titular=$this->_request->getPost('p_ctelef_movil_titular'); 
			$p_ctipdoc_garante=$this->_request->getPost('p_ctipdoc_garante');
			$p_desdoc_garante=$this->_request->getPost('p_desdoc_garante');
			$p_cnombres_garante=$this->_request->getPost('p_cnombres_garante');
			$p_cdomicilio_garante=$this->_request->getPost('p_cdomicilio_garante');
			$p_cdistrito_garante=$this->_request->getPost('p_cdistrito_garante');
			$p_ctelefono_garante=$this->_request->getPost('p_ctelefono_garante');
			$p_tif_mensual=$this->_request->getPost('p_tif_mensual');
			$p_tif_diario=$this->_request->getPost('p_tif_diario');
			$p_monto_deuda_total=$this->_request->getPost('p_monto_deuda_total');
			$p_monto_cuota_inicial=$this->_request->getPost('p_monto_cuota_inicial');
			$p_monto_deuda_regular=$this->_request->getPost('p_monto_deuda_regular');
			$p_numero_cuota=$this->_request->getPost('p_numero_cuota');
			$p_dfecha_emision=date('d-m-Y'); 
			$p_modelo_convenio_id=$this->_request->getPost('p_modelo_convenio_id');
			$p_cf_ampliado=$this->_request->getPost('p_cf_ampliado');
			$p_nestado=$this->_request->getPost('p_nestado');
			$p_vhostnm=$this->_request->getPost('p_vhostnm');
			$p_vusernm=$this->_request->getPost('p_vusernm');
            
            
			$ddatosuserlog = new Zend_Session_Namespace('datosuserlog');
			$userlogin = $ddatosuserlog->userlogin;
			
			$cn = new Model_DataAdapter ();
			$nombrestore = '"recaudacion".insertupdate_fr_convenios';
			$parametros [0] = $p_idsigma;
			$parametros [1] = $p_cnumfra;
			$parametros [2] = $p_canofra;
			$parametros [3] = $p_cidpers;
			$parametros [4] = $p_ctipdoc_titular;
			$parametros [5] = $p_descdoc_titular;
			$parametros [6] = $p_cnombres_titular;
			$parametros [7] = $p_cdomicilio_titular;
			$parametros [8] = $p_cdistrito_titular;
			$parametros [9] = $p_ctelef_fijo_titular;
			$parametros [10] = $p_ctelef_movil_titular;
			$parametros [11] = $p_ctipdoc_garante;
			$parametros [12] = $p_desdoc_garante;
			$parametros [13] = $p_cnombres_garante;
			$parametros [14] = $p_cdomicilio_garante;
			$parametros [15] = $p_cdistrito_garante;
			$parametros [16] = $p_ctelefono_garante;
			$parametros [17] = $p_tif_mensual;
			$parametros [18] = $p_tif_diario;
			$parametros [19] = $p_monto_deuda_total;
			$parametros [20] = $p_monto_cuota_inicial;
			$parametros [21] = $p_monto_deuda_regular;
			$parametros [22] = $p_numero_cuota;
			$parametros [23] = $p_dfecha_emision;
			$parametros [24] = $p_modelo_convenio_id;
			$parametros [25] = $p_cf_ampliado;
			$parametros [26] = $p_nestado;
			$parametros [27] = $this->view->util()->getHost();
			$parametros [28] = $userlogin;

			$datos = $cn->ejec_store_procedura_sql($nombrestore, $parametros);
			if ($datos[0][0] == '1') {
				
				$val[]=array('txtidsigmafracc',$datos[0][1],'val');
				 
				echo $datos[0][2].'-'.$datos[0][3];  
				
				
				$cn2 = new Model_DataAdapter ();
	     		$nombrestore2 = '"recaudacion".insertupdate_fr_convenios_detalle';
	     		
	     		
	    $montofracc=$p_monto_deuda_total - $p_monto_cuota_inicial;
        $cuotamonto;        
        $amortizacion=$montofracc;        
        $montodescuento=0;        
        $hoy = Date("d-m-Y");        
        $interes;        
        $Ui;        
        $xAux;        
        $R;        
        $xInteFra;        
        $totalfinal=0;        
        $interes = ((1.2 * 0.8)/100);        
        $Ui = 1 + $interes;
        
        for($i=1; $i<$p_numero_cuota; $i++){
        	$Ui = $Ui * (1 + $interes);
        }
         
        $xAux = ( $Ui - 1 ) / ($interes * $Ui);
         
        $R  = round($montofracc /$xAux,2);        
        
        for($i=0; $i<=$p_numero_cuota; ++$i){ 
         
        	$cd = strtotime(date('d-m-Y'));
        	$retDAY = date('d-m-Y', mktime(0,0,0,date('m',$cd)+$i,date('d',$cd),date('Y',$cd)));
        	//echo $retDAY ."</br>";  	
        	
        	if ($i==0){        

        		$parametros2 [0]= '';  
				$parametros2 [1]= $datos[0][1]; 
				$parametros2 [2]= $datos[0][2]; 
				$parametros2 [3]= $datos[0][3] ; 
				$parametros2 [4]= $i ;
				$parametros2 [5]= $p_monto_cuota_inicial ; 
				$parametros2 [6]= $p_monto_cuota_inicial ; 
				$parametros2 [7]= '0.04' ; 
				$parametros2 [8]= '0' ; 
				$parametros2 [9]= '0'; 
				$parametros2 [10]= '0' ;  
				$parametros2 [11]= $p_monto_cuota_inicial ;
				$parametros2 [12]= $p_monto_cuota_inicial  ; 
				$parametros2 [13]= date('d-m-Y') ; 
				$parametros2 [14]= $retDAY ; 
				$parametros2 [15]= '01/01/1900' ; 
				$parametros2 [16]= '1' ; 
				$parametros2 [17]= $this->view->util()->getHost(); 
				$parametros2 [18]= $userlogin ; 
				$parametros2 [19]= date('d-m-Y') ;
        		
        	}
        	else{
        
        		$xInteFra   = $amortizacion * $interes;
        		$montodescuento = $R - $xInteFra;
        	 			
        		$amortizacion = $amortizacion - $montodescuento;
        
        		$totalfinal = $totalfinal + ((($R)*100)/100) ;				

        		$parametros2 [0]= '';  
				$parametros2 [1]= $datos[0][1]; 
				$parametros2 [2]= $datos[0][2]; 
				$parametros2 [3]= $datos[0][3] ; 
				$parametros2 [4]= $i; 
				$parametros2 [5]= ((($R)*100)/100) ; 
				$parametros2 [6]= ((($R)*100)/100) ; 
				$parametros2 [7]= '0.04' ; 
				$parametros2 [8]= '0' ; 
				$parametros2 [9]= '0'; 			
				$parametros2 [10]= round(($xInteFra)*100)/100  ; 
				$parametros2 [11]= round(($montodescuento)*100)/100  ;
				$parametros2 [12]= ((($R)*100)/100) ; 
				$parametros2 [13]= date('d-m-Y');  
				$parametros2 [14]= $retDAY ; 
				$parametros2 [15]= '01/01/1900' ; 
				$parametros2 [16]= '1'; 
				$parametros2 [17]= $this->view->util()->getHost(); 
				$parametros2 [18]= $userlogin ; 
				$parametros2 [19]= date('d-m-Y') ;          		
        	}        
       
        	$datos2 = $cn2->ejec_store_procedura_sql($nombrestore2, $parametros2);
        }				
			} else {
				header("Status: 400 Error al Guardar intentelo en otro momento o contacte al adminsitrador");
			}
            
            
			
			}
		 $pintar=new Libreria_Pintar();	
		 $pintar->PintarValor($val); 	
	}

}
